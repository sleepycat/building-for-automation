<!DOCTYPE html>
<html>
  <head>
    <title>Building for automation</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width"
    />
    <link rel="stylesheet" type="text/css" href="./css/typo.css" />
    <link rel="stylesheet" type="text/css" href="./css/nord-dark.css" />
    <link rel="stylesheet" type="text/css" href="./css/font-nord.css" />
    <link rel="stylesheet" type="text/css" href="./css/bg-nord.css" />
    <link rel="stylesheet" type="text/css" href="./css/style.css" />
  </head>
  <body>
    <textarea id="source">


class: nord-dark, center, middle, title

.logo[🤖]

# Building for automation

---

class: nord-dark, left, middle

## HTTPS-everywhere

.eighty[![https-everywhere](images/https-everywhere.png)]

---
class: nord-dark, left, middle

.eighty[![dmarc](images/dmarc.png)]

---

class: nord-dark, left, middle

## Tracker

.eighty[![tracker](images/tracker-tour.gif)]

---


class: nord-dark, middle, left

## Automated answers about other peoples systems

* Are TLS/DMARC settings for a domain "good"?
* Are this/that group of domains "good"?
* Are this/that group of domains trending towards "good"?
* These answers are continuously updated

---

class: nord-dark, middle, left

## Questions are limited by the data we can get

* much of what the GoC cares about isn't visible from outside
* We definitely don't want access to see it from the inside

---

class: nord-dark, middle, left

## How can we enable automated answers about Tracker?

---

class: nord-dark, middle, left

## Important decisions at multiple layers

* Platform
* Infrastructure
* Languages
* Dependencies
* Workflow (who, and how)
* Inputs & validation
* Application code

---

class: nord-dark, left, middle

## Measurement requires data

* Platform: *data*
* Infrastructure: *data*
* Languages: *data*
* Dependencies: *data*
* Workflow (who, and how): *data*
* Inputs & validation: *data*
* Application code: ?

---

class: nord-dark, left, middle

## * as data: A tour of Tracker

* Platform: *Kubernetes*
* Infrastructure: *Config Connector*
* Languages: *GitHub API*
* Dependencies: *GitHub API*
* Workflow (who, and how): *GitHub API*
* Inputs & validation: *GraphQL*
* Application code: ? (CodeQL?)

---

class: nord-dark, center, middle

## Platform as data: Kubernetes

---

class: nord-dark, left, middle

## Infrastructure As Data: the other part

> ...describing what your systems look like in simple machine readable data formats. *Have programs execute those data formats and ensure your infrastructure matches*.

<cite>Michael DeHaan - founder of Ansible - O'Reilly Radar, 2013</cite>

---

class: nord-dark, middle, left

## Kubernetes
* provides a data format for describing your system
* executes that data
* ensures running system matches

.sync.sixty[![](images/kubernetes-sync.svg)]
---

class: nord-dark, left, middle

## What ports *should* be exposed?

```bash
$ git clone --depth 1 git@github.com:canada-ca/tracker.git && cd tracker
$ kustomize build platform/overlays/gke | \
>   yq 'select(.kind == "Service" and .spec.type == "LoadBalancer").spec.ports[].port'

80
443
```

---

class: nord-dark, left, middle

## What ports *are* exposed?

```bash
$ sudo nmap -p- --reason pulse.alpha.canada.ca
[sudo] password for mike:
Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-05 13:52 EDT
Nmap scan report for pulse.alpha.canada.ca (34.95.5.243)
Host is up, received syn-ack ttl 56 (0.046s latency).
rDNS record for 34.95.5.243: 243.5.95.34.bc.googleusercontent.com
Not shown: 65533 filtered ports
Reason: 65533 no-responses
PORT    STATE SERVICE REASON
* 80/tcp  open  http    syn-ack ttl 56 👀
* 443/tcp open  https   syn-ack ttl 56

Nmap done: 1 IP address (1 host up) scanned in 191.39 seconds
```

---
class: nord-dark, left, middle

## Kubernetes: config is canonical

---

class: nord-dark, left, middle

## What services are running on our platform?

```bash
$ kustomize build platform/overlays/gke |  yq 'select(.kind == "Service").metadata.name'
"dns-scanner"
"https-scanner"
"result-processor"
"ssl-scanner"
"postgres"
"tracker-api"
"cert-manager"
"cert-manager-webhook"
"tracker-frontend"
"istio-ingressgateway"
...
```

---

class: nord-dark, left, middle

## What versions are running?

```bash
$ kustomize build platform/overlays/gke | \
  yq 'select(.kind == "Deployment").spec.template.spec.containers[].image'
"gcr.io/track-compliance/api:master-fcb74ce"
"quay.io/jetstack/cert-manager-controller:v0.15.1"
"quay.io/jetstack/cert-manager-cainjector:v0.15.1"
"quay.io/jetstack/cert-manager-webhook:v0.15.1"
"gcr.io/track-compliance/frontend:master-096601c"
"docker.io/istio/proxyv2:1.6.4"
"docker.io/jaegertracing/all-in-one:1.16"
"docker.io/istio/pilot:1.6.4"
"quay.io/kiali/kiali:v1.18"
"docker.io/prom/prometheus:v2.15.1"
"docker.io/istio/proxyv2:1.6.4"
"grafana/grafana:latest"
"prom/prometheus:v2.12.0"
```

---

class: nord-dark, middle, left

## Infrastructure as data: Config Connector

---

class: nord-dark, middle, left

## Kubernetes
* provides a data format for describing your system
* executes that data
* ensures running system matches

.sync.sixty[![](images/kubernetes-sync.svg)]

---

class: nord-dark, middle, left

## Config Connector
* provides 91 resources describing GCP infrastructure
* Extends Kubernetes to act on these new types

.sync.sixty[![](images/config-connector-sync.svg)]

---

class: nord-dark, middle, left

## New additions to the Kubernetes world

```yaml
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: sqluser-dep
spec:
  region: us-central1
  databaseVersion: MYSQL_5_7
  settings:
    tier: db-n1-standard-1
```

---

class: nord-dark, middle, left

## How many security/policy requirements apply?

```yaml
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: sqluser-dep
spec:
  region: us-central1
  databaseVersion: MYSQL_5_7
  settings:
    tier: db-n1-standard-1
```

---

class: nord-dark, middle, left

## How many security/policy requirements apply?

```yaml
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: sqluser-dep
spec:
*  region: us-central1
  databaseVersion: MYSQL_5_7
  settings:
    tier: db-n1-standard-1
```

---

class: nord-dark, middle, left

## How many security/policy requirements apply?

```yaml
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: sqluser-dep
spec:
  region: us-central1
*  databaseVersion: MYSQL_5_7
  settings:
    tier: db-n1-standard-1
```

---

class: nord-dark, middle, left

## Mapping GoC requirements to 91 pieces of data is a tractable problem

---

class: nord-dark, middle, left

## Kubernetes

```yaml
# Our GKE cluster
apiVersion: container.cnrm.cloud.google.com/v1beta1
kind: ContainerCluster
metadata:
  annotations:
    cnrm.cloud.google.com/remove-default-node-pool: "false"
  name: tracker-two-dot-oh
  namespace: tracker
spec:
  # Place this cluster in Montreal for data residency
  # https://cloud.google.com/about/locations/montreal
  location: northamerica-northeast1
  initialNodeCount: 1
  # Logs are centralized by default in Stackdriver
  # Our least privilege account gives nodes permission to write to these
  # logging and monitoring services
  loggingService: logging.googleapis.com/kubernetes
  monitoringService: monitoring.googleapis.com/kubernetes
  masterAuth:
    # No credentials here since nobody should log into master nodes
    clientCertificateConfig:
      issueClientCertificate: false
  # Secrets are not currently encrypted within etcd
  # databaseEncryption:
  #   keyName: string
  #   state: string
  addonsConfig:
    # Enable "Cloud Run for Anthos"
    # We use this feature for the domain scanning
    cloudrunConfig:
      disabled: false
  # Enable Workload Identity
  workloadIdentityConfig:
    identityNamespace: "track-compliance.svc.id.goog"
  enableShieldedNodes: true
  # Subscribe to a release channel so Kubernetes is auto-upgraded for us
  releaseChannel: # immutable field
    channel: REGULAR # RAPID, REGULAR, or STABLE
  nodeConfig:
    diskSizeGb: 100
    # Node auto-upgrades are enabled by default
    imageType: COS_CONTAINERD
    machineType: n1-standard-4
    diskType: pd-standard
    shieldedInstanceConfig: # immutable fields
      enableIntegrityMonitoring: true
      enableSecureBoot: true
    serviceAccountRef:
      # Nodes should use our least privilege account
      external: gke-least-privilege-account@track-compliance.iam.gserviceaccount.com
---
```

---


class: nord-dark, middle, left

## NIST SP 800-190 guidance on Minimal OS?

```bash
$ cat tracker.yaml | \
 yq 'select(.kind == "ContainerCluster").spec | { imageType: .nodeConfig.imageType }'
{
  "imageType": "COS_CONTAINERD"
}

```
---

class: nord-dark, middle, left

## Security: Shielded nodes on GKE?

```bash
$ cat tracker.yaml | \
 yq 'select(.kind == "ContainerCluster").spec | { enableShieldedNodes }'
{
  "enableShieldedNodes": true
}

```
---


class: nord-dark, middle, left

## Security: Accounts and permissions

```bash
$ cat tracker.yaml | \
 yq 'select(.kind == "IAMServiceAccount") | {kind: .kind, name: .metadata.name } '
{
  "kind": "IAMServiceAccount",
  "name": "gke-least-privilege-account"
}
```

---

class: nord-dark, middle, left

## Security: permissions

```bash
$ cat tracker.yaml | \
 yq 'select(.kind == "IAMPolicyMember").spec | {role, member} | select(.member | contains("serviceAccount"))'
{
  "role": "roles/logging.logWriter",
  "member": "serviceAccount:gke-least-privilege-account@track-compliance.iam.gserviceaccount.com"
}
{
  "role": "roles/monitoring.metricWriter",
  "member": "serviceAccount:gke-least-privilege-account@track-compliance.iam.gserviceaccount.com"
}
{
  "role": "roles/monitoring.viewer",
  "member": "serviceAccount:gke-least-privilege-account@track-compliance.iam.gserviceaccount.com"
}

```

---

class: nord-dark, middle, left

## * as data: A tour

* Platform: *Kubernetes*
* Infrastructure: *Config Connector*
* Languages: *GitHub API*
* Dependencies: *GitHub API*
* Workflow (who, and how): *GitHub API*
* Inputs & validation: *GraphQL*
* Application code: ? (CodeQL?)

---

class: nord-dark, middle, left

### We adopted new tools to get platform/infrastructure as data

---

class: nord-dark, middle, left

### Where we do the work can give us access to more data

---

class: nord-dark, middle, left

# GitHub ~~the code hosting service~~

---

class: nord-dark, middle, left

# GitHub the platform

---

class: nord-dark, left, middle

## Platform?

> A platform abstracts away a messy problem so you can build on top of it.

<cite>Sam Ghods -- CoFounder of Box</cite>

---

class: nord-dark, middle, left

## GitHub does more than host your code

* it understands languages
* it understands common dependency manifests
* it looks for vulnerable dependencies
* recognizes cloud credentials
* it records actions taken (opening/closing issues/PRs)
* makes all of this available as data via it's API

---


class: nord-dark, middle, left

# Languages as data: GitHub API

---

class: nord-dark, middle, left

# Languages matter for security
* "Microsoft has deemed C++ no longer acceptable for writing mission-critical software."[1]
* JavaScript has language level SQL injection prevention
* Golang:	CVE-2019-14809 net/url authorization bypass
* Rust 😍

<cite>[1] https://thenewstack.io/microsoft-rust-is-the-industrys-best-chance-at-safe-systems-programming/</cite>
---


class: nord-dark, middle, left

## What programming languages are used?

```graphql
{
  repository(owner: "canada-ca" name: "tracker") {
    nameWithOwner
    languages(first: 3) {
      edges {
        node {
          name
        }
      }
    }
  }
}

```
---

class: nord-dark, middle, left

```json
{
  "data": {
    "repository": {
      "nameWithOwner": "canada-ca/tracker",
      "languages": {
        "edges": [
          {
            "node": {
              "name": "Dockerfile"
            }
          },
          {
            "node": {
              "name": "Python"
            }
          },
          {
            "node": {
              "name": "JavaScript"
            }
          }
        ]
      }
    }
  }
}
```
---

class: nord-dark, middle, left

## Dependencies as data: GitHub API

---

class: nord-dark, middle, left

## Dependencies matter for security

> OSS Components Make Up 90% of a Modern Application


<cite>[1] Sonatype's 2020 State of Software Supply Chain.</cite>
---

class: nord-dark, middle, left

## What dependencies does this project have?

```graphql
{
  repository(owner: "canada-ca", name: "tracker") {
    dependencyGraphManifests(first: 1) {
      edges {
        node {
          filename
          dependenciesCount
          dependencies(first: 5) {
            nodes {
              packageName
            }
          }
        }
      }
    }
  }
}

```
---

class: nord-dark, middle, left

```json
{
  "data": {
    "repository": {
      "dependencyGraphManifests": {
        "edges": [
          {
            "node": {
              "filename": "api/Pipfile",
              "dependenciesCount": 23,
              "dependencies": {
                "nodes": [
                  {
                    "packageName": "bcrypt"
                  },
                  {
                    "packageName": "flask"
                  }
                ]
              }
            }
          }
        ]
      }
    }
  }
}
```

---

class: nord-dark, middle, left

## Bonus: Vulnerabilities as data!
(PHP, Java, .NET, Python, Ruby, JavaScript)

```graphql
{
  repository(owner: "canada-ca" name: "tracker") {
    vulnerabilityAlerts(first: 5)  {
      edges {
        node {
          securityVulnerability {
            severity
            advisory {
              description
            }
          }
        }
      }
    }
  }
}
```
---

class: nord-dark, middle, left

```json
{
  "data": {
    "repository": {
      "vulnerabilityAlerts": {
        "edges": []
      }
    }
  }
}
```

---


class: nord-dark, middle, left

# Workflow as data

---

class: nord-dark, middle, left

## Who are the "outside collaborators" on this repo?

```graphql
{
  repository(owner: "canada-ca", name: "tracker") {
    collaborators(first: 50 affiliation: DIRECT) {
      edges {
        node {
          login
        }
      }
    }
  }
}
```

---

class: nord-dark, middle, left

## Who are the "outside collaborators" on this repo?

```json
{
  "data": {
    "repository": {
      "collaborators": {
        "edges": [
          {
            "node": {
              "login": "sleepycat"
            }
          },
          {
            "node": {
              "login": "nslandolt"
            }
          },
          {
            "node": {
              "login": "peacheym"
            }
          },
          {
            "node": {
              "login": "tparrott-cse"
            }
          },
          {
            "node": {
              "login": "Ethanljf"
            }
          },
          {
            "node": {
              "login": "FestiveKyle"
            }
          },
          {
            "node": {
              "login": "greggoryelton"
            }
          },
          {
            "node": {
              "login": "michaeldavie-cyber"
            }
          },
          {
            "node": {
              "login": "lcampbell2"
            }
          }
        ]
      }
    }
  }
}
```
---

class: nord-dark, middle, left

## Who has admin access to this repo?

```graphql
{
  repository(owner: "canada-ca", name: "tracker") {
    collaborators(first: 50 affiliation: ALL) {
      edges {
        permission
        node {
          login
        }
      }
    }
  }
}
```
---

class: nord-dark, middle, left

## Who has access to this repo?

```bash
$ cat users.json | jq '.data.repository.collaborators.edges[].node.login' | wc -l
46
$ cat users.json | jq '.data.repository.collaborators.edges[].permission == "ADMIN"' | grep -c true
7
```
---

class: nord-dark, middle, left

## Are we doing code review?

```graphql
{
  repository(owner: "canada-ca", name: "tracker") {
    nameWithOwner
    pullRequests(last: 5 states: MERGED) {
      nodes {
        author {
          login
        }
        reviews(last: 1) {
          edges {
            node {
              author {
                login
              }
            }
          }
        }
      }
    }
  }
}
```
---

class: nord-dark, middle, left

```json
{
  "data": {
    "repository": {
      "nameWithOwner": "canada-ca/tracker",
      "pullRequests": {
        "nodes": [
          {
            "author": {
              "login": "FestiveKyle"
            },
            "reviews": {
              "edges": [
                {
                  "node": {
                    "author": {
                      "login": "sleepycat"
                    }
                  }
                }
              ]
            }
          },
          {
            "author": {
              "login": "sleepycat"
            },
            "reviews": {
              "edges": []
            }
          },
        ]
      }
    }
  }
}
```
---

class: nord-dark, middle, left

# Validation as data: GraphQL

---

class: nord-dark, middle, left

## Schema validation protects the data

.eighty[![https-everywhere](images/three-tier.svg)]

---

class: nord-dark, middle, left

## Schema validation protects everything

.eighty[![https-everywhere](images/three-tier-graphql.svg)]

---

class: nord-dark, middle, left

## Validate with your own data types

.eighty[![https-everywhere](images/sin-schema.png)]

---

class: nord-dark, middle, left

## Validate with your own data types

.eighty[![https-everywhere](images/graphql-sin.png)]

---

class: nord-dark, middle, left

### When your schema is data, validations are observable

.eighty[![https-everywhere](images/schema-as-data.png)]

---

class: nord-dark, left, middle

### When your schema is data, validations are auditable

```bash
$ npx graphql-attack-surface https://pulse.alpha.canada.ca/graphql


findDomainsByOrg accepts the following string inputs:
  before accepts a value of String
  after accepts a value of String


findMyDomains accepts the following string inputs:
  before accepts a value of String
  after accepts a value of String


findMyOrganizations accepts the following string inputs:
  before accepts a value of String
  after accepts a value of String


userList accepts the following string inputs:
  before accepts a value of String
  after accepts a value of String


authenticateTwoFactor accepts the following string inputs:
  otpCode accepts a value of String!

```

---

class: nord-dark, middle, left

## When your schema is data, it can be visualized

---

background-image: url(images/graphql-voyager.png)

---

class: nord-dark, left, middle

## * as data: A tour

* Platform: *Kubernetes*
* Infrastructure: *Config Connector*
* Languages: *GitHub API*
* Dependencies: *GitHub API*
* Workflow (who, and how): *GitHub API*
* Inputs & validation: *GraphQL*
* Application code: ? (CodeQL?)

---

class: nord-dark, middle, left

# Building this way is enabling automation

* Platform: *data*
* Infrastructure: *data*
* Languages: *data*
* Dependencies: *data*
* Workflow (who, and how): *data*
* Inputs & validation: *data*
* Application code: ?

---

class: nord-dark, left, middle

## Things we've learned

* Automation (security and otherwise) is built on data

--

* Most things can be turned into data (via tech or platforms)

--

* If data is public, analysis doesn't need special access

--

* The gap between documents and reality is a problem

--

* The gap between data and reality is fixable

---

class: nord-dark, middle, left

### 2 infinite loops, 0 configuration drift

.eighty[![gitops](images/gitops2.svg)]

---

class: nord-dark, middle, left

### 2 infinite loops, 0 configuration drift

.eighty[![gitops](images/gitops.svg)]

---

class: nord-dark, left, middle

## More things we've learned

* Much of the security/compliance work could be automated...

--

* ...if dev/ops choose tech/tools that fit the "* as data" paradigm

---

class: nord-dark, left, middle

## We need experiments like this

* Dev: 🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈<br/>
* Ops: 🐈🐈🐈🐈🐈🐈🐈🐈🐈🐈
* Sec: 🐈

---

class: nord-dark, middle, center

## Fin



    </textarea>

    <script src="js/remark.min.js"></script>
    <script>
      var slideshow = remark.create({
        ratio: "16:9", // window ratio
        // arta, ascetic, dark, default, far, github, googlecode, idea,
        // ir-black, magula, monokai, rainbow, solarized-dark, solarized-light,
        // sunburst, tomorrow, tomorrow-night-blue, tomorrow-night-bright,
        // tomorrow-night, tomorrow-night-eighties, vs, zenburn.
        highlightStyle: "dark",
        highlightLines: true,
        countIncrementalSlides: false, // whether the incremental content count as one page
        //slideNumberFormat: "", // If this parameter is set to "", the page number is not displayed
        navigation: {
          scroll: false, // Page turning with mouse wheel is allowed
          touch: true, // Is it allowed to scroll back and forth by clicking on the left or right side of the screen
          click: false // Allow the mouse to click on the left or right side of the screen to turn back and forth
        }
      });

    </script>
  </body>
</html>
